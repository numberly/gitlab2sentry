# gitlab2sentry

This project aims to automate Sentry project creation. Moreover it aims to create a sentry project for every gitlab team's project.

The script aims to add sentry for every new project you have created.


## Two-Steps process

1. After creating your new project, in your gitlab, ```gitlab2sentry``` will create the first Pull Request. This pull request will contain the creation of the ```.sentryclirc``` file. Although, it will not contain the ```DSN``` for this project and no project will be created to ```sentry```

2. Once the user has merged the first Pull request, ```gitlab2sentry``` will create the second Pull Request. This pull request will update the newly created ```.sentryclirc``` file with the ```DSN``` of the sentry project. Moreover, after the merge of the first Pull Request ```gitlabsentry``` will create a new ```sentry project```, update its rate limit and save the ```DSN``` inside ```.sentryclirc```. Once the user has merged the second pull request everything will be set up.

**NOTE**: ```Gitlab2Sentry``` looks only for group projects and searches for PRs having specific keyword inside (check "Configuration" section)


## Run locally

You can install all requirements for this project with

```
python3 -m venv venv
pip3 install -r requirements.txt
source venv/bin/ac
```

After the installation of all requirements you have to:

```
export SENTRY_URL=<your sentry's url>
export SENTRY_TOKEN=<your sentry token>
export SENTRY_ENV=<your environment - default production>
export GITLAB_TOKEN=<your gitlab token>
export GITLAB_URL=<your gitlab url>
python3 run.py
```

## Deployment

We prefer to deploy and manage ```gitlab2sentry``` with ```helm```. Inside ```helm/``` folder you can find an example deployment.

You can upgrade your deployment with:

```
make upgrade
```

## Configuration

```Gitlab2Sentry``` requires some configuration in 3 specific files.

1. First of all you have to configure the ```g2s.yaml``` file where everything is configured for the ```gitlab2sentry``` service. Here you can find a description for every field:

```
sentry:
  # Sentry configuration.
  slug: <your sentry organization>
gitlab:
  # DSN PR configuration.
  dsn_mr:
    # Default values for dsn (2nd) pull request configuration.
    content: |
      ## File generated by gitlab2sentry
      [defaults]
      url = {sentry_url}
      dsn = {dsn}
    description: <your description in the DSN PR>
    branch_name: <default dsn branch name>
    title: <default title of the dsn mr>
  # Sentryclirc PR configuration.
  sentryclirc_mr:
    # Default values for .sentryclirc (1st) pull request configuration.
    content: |
      ## File generated by gitlab2sentry
      [defaults]
      url = {sentry_url}
    description: <your description in the sentryclirc MR>
    branch_name: <your sentryclirc branch_name
    filepath: .sentryclirc
    commit_message: <commit message>
    title: <default title of the sentryclirc mr>
  # Gitlab configuration.
  config:
    author:
      name: <name>
      email: <email>
    graphql_suffix: <endpoint of gitlab graphql>
    # Mention some specific people.
    mentions:
      - "@<mention>
      - # everyone you want to include on those MRs
    # If no "mentions" field is included, you have to define
    # The access_level of those who will be mentioned in your PR.
    mentions_access_level: 40
    # This keyword must be included in your Pull Request title.
    # Gitlab2sentry will search with this keyword for PRs
    keyword: sentry
    # How old has to be the projects checked from gitlab2sentry
    creation_days_limit: 60
    # Do you want to remove the source branch after merge?
    remove_source: true
    # Gitlab2Sentry searches only for group projects.
    group_identifier: <define a keyword for the groups you want to include>
    # Configure the aiohttp timeout for the GraphQL API of gitlab
    graphql_aiohttp_timeout: 40
    # How many items per page will have the response of the GraphQL API.
    graphql_page_length: 100
```

2. If you want to follow the ```helm``` deployment process you will have to fill your details into the ```helm/values-production.yaml``` and ```helm/Chart.yaml```.

3. You can update ```REG ?= your-registry``` and ```NS	?= your-namespace``` values inside ```Makefile```.