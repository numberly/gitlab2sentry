# gitlab2sentry

Getting a Sentry project for each of your Gitlab repositories is just one MR merge away!

Gitlab2Sentry will create a Sentry project associated to each of your Gitlab repositories using a Merge Request based automated workflow.

Any new Gitlab repository you create will be offered a Sentry project if you accept (merge the proposal MR) it with respect to the Gitlab group owning it!

## Two-Steps process

1. After creating your new project on Gitlab, ```gitlab2sentry``` will create a first Merge Request asking if you want it to create an associated Sentry project for it. This Merge Request will contain the creation of a ```.sentryclirc``` file which, if you merge it, will be contributed back the newly created Sentry project ```DSN``` for this project.

2. If you merged the first Merge Request, ```gitlab2sentry``` will create a second one to update the newly created ```.sentryclirc``` file with the ```DSN``` of the sentry project. Moreover, after the merge of the first Merge Request ```gitlabsentry``` will create a new ```sentry project```, update its rate limit and save the ```DSN``` inside ```.sentryclirc```. Once you have merged this second Merge Request everything will be set up!

**NOTE**: ```Gitlab2Sentry``` looks only for group projects and searches for MRs having specific keyword inside (check "Configuration" section)


## Run locally

You can install all requirements for this project with:

```bash
python3 -m venv venv
pip3 install -r requirements.txt
source venv/bin/ac
```

After the installation of all requirements you have to:

```bash
export SENTRY_URL=<your sentry's url>
export SENTRY_TOKEN=<your sentry token>
export SENTRY_ENV=<your environment - default production>
export GITLAB_TOKEN=<your gitlab token>
export GITLAB_URL=<your gitlab url>
python3 run.py
```

## Deployment

We prefer to deploy and manage ```gitlab2sentry``` with ```helm```. Inside ```helm/``` folder you can find an example deployment.

You can upgrade your deployment with:

```bash
make upgrade
```

## Configuration

```Gitlab2Sentry``` requires some configuration in 3 specific files.

1. First of all you have to configure the ```g2s.yaml``` file where everything is configured for the ```gitlab2sentry``` service. Here you can find a description for every field:

```yaml
sentry:
  # Sentry configuration.
  slug: <your sentry organization>

gitlab:
  # DSN PR configuration.
  dsn_mr:
    # Default values for dsn (2nd) pull request configuration.
    content: |
      ## File generated by gitlab2sentry
      [defaults]
      url = {sentry_url}
      dsn = {dsn}
    description: <your description in the DSN PR>
    branch_name: <default dsn branch name>
    title: <default title of the dsn mr>

  # Sentryclirc PR configuration.
  sentryclirc_mr:
    # Default values for .sentryclirc (1st) pull request configuration.
    content: |
      ## File generated by gitlab2sentry
      [defaults]
      url = {sentry_url}
    description: <your description in the sentryclirc MR>
    branch_name: <your sentryclirc branch_name
    filepath: .sentryclirc
    commit_message: <commit message>
    title: <default title of the sentryclirc mr>

  # Gitlab configuration.
  config:
    author:
      name: <name>
      email: <email>
    graphql_suffix: <endpoint of gitlab graphql>
    # Mention some specific people.
    mentions:
      - "@<mention>
      - # everyone you want to include on those MRs
    # If no "mentions" field is included, you have to define
    # The access_level of those who will be mentioned in your PR.
    mentions_access_level: 40
    # This keyword must be included in your Pull Request title.
    # Gitlab2sentry will search with this keyword for PRs
    keyword: sentry
    # How old has to be the projects checked from gitlab2sentry
    creation_days_limit: 60
    # Do you want to remove the source branch after merge?
    remove_source: true
    # Gitlab2Sentry searches only for group projects.
    group_identifier: <define a keyword for the groups you want to include>
    # Configure the aiohttp timeout for the GraphQL API of gitlab
    graphql_aiohttp_timeout: 40
    # How many items per page will have the response of the GraphQL API.
    graphql_page_length: 100
```

2. If you want to follow the ```helm``` deployment process you will have to fill your details into the ```helm/values-production.yaml``` and ```helm/Chart.yaml```.

3. You can update ```REG ?= your-registry``` and ```NS	?= your-namespace``` values inside ```Makefile```.

## Contributions & comments welcomed

Numberly decided to Open Source this project because it saves a lot of time internally to all our developers and helped foster the mass adoption of Sentry in all our Tech teams. We hope this project can benefit someone else.

Feel free to ask questions, suggest improvements and of course contribute features or fixes you might need!

